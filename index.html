<!DOCTYPE html>
<html lang="ja">

<head>
    <title>SUGARJOY</title>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="bmstable" content="header.json" />
    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW" crossorigin="anonymous">
    </script>
</head>

<body>
    <header class="mb-3">
        <nav class="navbar navbar-dark bg-dark">
            <div class="container-fluid">
                <span class="navbar-brand mb-0 h1">SUGARJOY</span>
            </div>
        </nav>
    </header>

    <div class="container">

        <div class="alert alert-success mb-3" role="alert">
            <p>SU-3=sl0~4　SU-2=sl5~8  SU-1=sl9~12　SU0以降はst0基準</p>
            <p>T/N0.18を下回る低TOTALやobj名が未記載の差分は初期の譜面でズレチェック行ってない可能性大</p>
            <p>糞譜面度0=Stella  糞譜面度1=発狂BMS  糞譜面度2=第二発狂やソロモン  糞譜面度3=引退</p>
            <p>難易度表の読み込みと表示に数秒かかります。</p>
            <hr>
            <p class="mb-0">改修中</p>
        </div>
        
        <!--ここから難易度表本体-->
        <div>
            <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="mergeDuplicates">
            <label class="form-check-label" for="mergeDuplicates">
            重複楽曲をまとめる
            </label>
        </div>
            <table class="table table-light table-striped table-hover" id="table_int">
            </table>
        </div>
        <script language="javascript" type="text/javascript">
            $(document).ready(function () {
                $.getJSON($("meta[name=bmstable]").attr("content"), function (header) {
                    $.getJSON(header.data_url, function (information) {
                        // グローバルにデータを保存
                        window.tableData = information;
                        window.tableSymbol = header.symbol;
                        makeBMSTable(information, header.symbol);
                    });
                });
                    // チェックボックス変更時に表を再描画
                    $("#mergeDuplicates").change(function () {
                    makeBMSTable(window.tableData, window.tableSymbol);
            });
        });

function makeBMSTable(info, mark) {
    var x = "";
    var count = 0;
    var obj = $("#table_int");

    // チェックボックスの状態
    const mergeDuplicates = $("#mergeDuplicates").is(":checked");

    // グループ化と最高レベル選択
    function groupDuplicates(data) {
        const groups = {};
        data.forEach(item => {
            const groupKey = item.group || item.title; // groupが空ならtitleで個別扱い
            if (!groups[groupKey]) groups[groupKey] = [];
            groups[groupKey].push(item);
        });

        // 各グループでSUdustを除く最高レベルの楽曲を選択
        return Object.values(groups).map(group => {
            // SUdustを除外し、levelを数値変換
            const validItems = group.filter(item => item.level !== "SUdust");
            if (validItems.length === 0) return group; // SUdustしかない場合

            // 最高レベルの楽曲を選択
            const maxLevelItem = validItems.reduce((max, item) => {
                const level = parseInt(item.level, 10) || 0;
                const maxLevel = parseInt(max.level, 10) || 0;
                return level > maxLevel ? item : max;
            }, validItems[0]);

            // グループ全体を返す（maxLevelItemを先頭に）
            return [maxLevelItem, ...group.filter(item => item !== maxLevelItem)];
        });
    }

    // データ処理
    const displayData = mergeDuplicates ? groupDuplicates(info) : info.map(item => [item]);

    obj.html("");
    $("<thead class='table-dark'><tr><th>Level</th><th>Title</th><th>Artist</th><th>T/N</th><th>BPM</th><th>差分DL</th><th>糞譜面度</th><th>Comment</th></tr></thead><tbody>")
        .appendTo(obj);
    var obj_sep = null;

    displayData.forEach(group => {
        const firstItem = group[0]; // 代表楽曲（最高レベル）
        if (x != firstItem.level) {
            if (obj_sep != null) {
                obj_sep.html("<td colspan='8'>" + "<b>" + mark + x + " (" + count + "譜面)</b></td>");
            }
            obj_sep = $("<tr class='table-dark' style='text-align:center' id='" + mark + firstItem.level + "'></tr>");
            obj_sep.appendTo(obj);
            count = 0;
            x = firstItem.level;
        }

        var str = $("<tr></tr>");

        // Level
        $("<td width='5%'>" + mark + x + "</td>").appendTo(str);

        // Title
        let titleText = firstItem.title;
        let titleHtml = "<a href='https://stellabms.xyz/upload/4428' target='_blank'>" + titleText + "</a>";
        if (mergeDuplicates && group.length > 1) {
            const tooltipContent = group.map(item => `${item.level}: ${item.title}`).join("<br>");
            titleHtml = "<a href='https://stellabms.xyz/upload/4428' target='_blank' data-bs-toggle='tooltip' data-bs-html='true' title='" + tooltipContent + "'>" + titleText + " (+" + (group.length - 1) + ")</a>";
        }
        $("<td width='20%'>" + titleHtml + "</td>").appendTo(str);

        // Artist
        $("<td width='20%'>" + firstItem.artist + "</td>").appendTo(str);

        // T/N
        $("<td width='15%'>" + firstItem.tn + "</td>").appendTo(str);

        // BPM
        $("<td width='10%'>" + firstItem.bpm + "</td>").appendTo(str);

        // 差分DL
        $("<td width='10%'>" +
            "<a href='" + (firstItem["差分DL"] || "") + "' target='_blank'>DL</a></td>").appendTo(str);

        // 糞譜面度
        $("<td width='10%'>" + (firstItem["糞譜面度"] || "") + "</td>").appendTo(str);

        // Comment
        $("<td width='10%'>" + firstItem.comment + "</td>").appendTo(str);

        str.appendTo(obj);
        count++;
    });

    $("</tbody>").appendTo(obj);
    if (obj_sep != null) {
        obj_sep.html("<td class='table-dark' style='text-align:center' colspan='8'>" + "<b>" + mark + x + " (" + count + "譜面)</b></td>");
    }

    // ツールチップ初期化
    $('[data-bs-toggle="tooltip"]').tooltip();
}
        </script>
    </div>

</html>
